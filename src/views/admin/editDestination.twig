{% extends "base.twig" %}

{% block style %}
  <link rel="stylesheet" href="/assets/css/editForm.css">
{% endblock %}

{% block title %}Modifier la destination{% endblock %}

{% block main %}
<h1>Modifier la destination</h1>

<form method="POST" action="/admin/destinations/edit/{{ destination.id }}" enctype="multipart/form-data" id="destination-form">
  <input type="hidden" name="_method" value="PUT">

  <label>Titre :</label>
  <input type="text" name="titre" value="{{ destination.titre }}" required>

  <label>Pays :</label>
  <input type="text" name="pays" value="{{ destination.pays }}" required>

  <label>Continent :</label>
  <select name="continent" required>
    {% for c in ["Afrique", "Amérique du Nord", "Amérique du Sud", "Asie", "Europe", "Océanie", "Antarctique"] %}
      <option value="{{ c }}" {{ c == destination.continent ? 'selected' : '' }}>{{ c }}</option>
    {% endfor %}
  </select>

  <label>Description :</label>
  <textarea name="description" required>{{ destination.description }}</textarea>

  <label>Image principale actuelle :</label><br>
  {% if destination.imagePrincipale %}
    <img src="{{ destination.imagePrincipale }}" alt="Image actuelle" width="150"><br>
  {% endif %}
  <label>Nouvelle image principale (facultatif) :</label>
  <input type="file" name="imagePrincipale" accept="image/*">

  <hr>

  <h2>Sections</h2>
  <div id="sections-container">
    {% for section in destination.sections %}
      <div class="section-block">
        <input type="hidden" name="sections[{{ loop.index0 }}][id]" value="{{ section.id }}">

        <label>Titre :</label>
        <input type="text" name="sections[{{ loop.index0 }}][titre]" value="{{ section.titre }}" required>

        <label>Type :</label>
        <input type="text" name="sections[{{ loop.index0 }}][type]" value="{{ section.type }}" required>

        <label>Contenu :</label>
        <textarea name="sections[{{ loop.index0 }}][contenu]" required>{{ section.contenu }}</textarea>

        <div>
          <h4>Images associées :</h4>
          {% for img in section.images %}
            <div>
              <img src="{{ img.url }}" width="100">
              <button type="button" onclick="markDeleted(this, 'deletedImages', '{{ img.id }}')">❌ Supprimer</button>
            </div>
          {% endfor %}
        </div>

        <div class="grouped-bullets-wrapper" id="grouped-{{ loop.index0 }}">
          <h4>Groupes de bullet points</h4>
          {% for group in section.groupedPoints %}
            <div class="grouped-bullet-block">
              <input type="hidden" name="sections[{{ loop.parent.loop.index0 }}][groups][{{ loop.index0 }}][id]" value="{{ group.id }}">
              <label>Titre du groupe :</label>
              <input type="text" name="sections[{{ loop.parent.loop.index0 }}][groups][{{ loop.index0 }}][titre]" value="{{ group.titre }}" required>

              {% for bp in group.contents %}
                <div>
                  <input type="text" name="sections[{{ loop.parent.parent.loop.index0 }}][groups][{{ loop.parent.loop.index0 }}][contenus][]" value="{{ bp.contenu }}" required>
                  <button type="button" onclick="markDeleted(this, 'deletedBulletPoints', '{{ bp.id }}')">❌</button>
                </div>
              {% endfor %}

              <button type="button" onclick="markDeleted(this.closest('.grouped-bullet-block'), 'deletedGroups', '{{ group.id }}')">❌ Supprimer ce groupe</button>
            </div>
          {% endfor %}
        </div>

        <div class="images-wrapper" id="images-{{ loop.index0 }}">
          <h4>Ajouter de nouvelles images :</h4>
        </div>
        <button type="button" onclick="addImage({{ loop.index0 }})">➕ Ajouter image</button>

        <button type="button" onclick="markDeleted(this.closest('.section-block'), 'deletedSections', '{{ section.id }}')">❌ Supprimer cette section</button>
        <hr>
      </div>
    {% endfor %}
  </div>

  <button type="button" onclick="addSection()">➕ Ajouter une nouvelle section</button>
  <div id="deleted-inputs"></div>
  <br>
  <button type="submit">✅ Enregistrer</button>
</form>

<script>
  function markDeleted(element, type, id) {
    element.remove();
    const hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.name = `deleted[${type}][]`;
    hidden.value = id;
    document.getElementById('deleted-inputs').appendChild(hidden);
  }

  let sectionIndex = {{ destination.sections.length }};

  function addSection() {
    const container = document.getElementById('sections-container');
    const section = document.createElement('div');
    section.className = 'section-block';
    section.innerHTML = `
      <label>Titre :</label>
      <input type="text" name="sections[${sectionIndex}][titre]" required>

      <label>Type :</label>
      <input type="text" name="sections[${sectionIndex}][type]" required>

      <label>Contenu :</label>
      <textarea name="sections[${sectionIndex}][contenu]" required></textarea>

      <div class="grouped-bullets-wrapper" id="grouped-${sectionIndex}">
        <h4>Groupes de bullet points</h4>
      </div>
      <button type="button" onclick="addGroupedBulletPoint(${sectionIndex})">➕ Ajouter un groupe de bullet points</button>

      <div class="images-wrapper" id="images-${sectionIndex}">
        <h4>Images associées</h4>
      </div>
      <button type="button" onclick="addImage(${sectionIndex})">➕ Ajouter image</button>

      <button type="button" onclick="this.closest('.section-block').remove()">❌ Supprimer cette section</button>
      <hr>
    `;
    container.appendChild(section);
    sectionIndex++;
  }

  function addImage(sectionId) {
    const imageContainer = document.getElementById(`images-${sectionId}`);
    const input = document.createElement('input');
    input.type = 'file';
    input.name = `sections[${sectionId}][images][]`;
    input.accept = 'image/*';
    imageContainer.appendChild(input);
  }

  function addGroupedBulletPoint(sectionId) {
    const wrapper = document.getElementById(`grouped-${sectionId}`);
    const groupIndex = wrapper.querySelectorAll('.grouped-bullet-block').length;

    const group = document.createElement('div');
    group.className = 'grouped-bullet-block';
    group.innerHTML = `
      <label>Titre du groupe :</label>
      <input type="text" name="sections[${sectionId}][groups][${groupIndex}][titre]" required>

      <div id="group-bullets-${sectionId}-${groupIndex}">
        <h5>Liste des bullet points :</h5>
      </div>
      <button type="button" onclick="addBulletPoint(${sectionId}, ${groupIndex})">➕ Ajouter bullet point</button>
      <hr>
    `;
    wrapper.appendChild(group);
  }

  function addBulletPoint(sectionId, groupIndex) {
    const container = document.getElementById(`group-bullets-${sectionId}-${groupIndex}`);
    const div = document.createElement('div');
    div.innerHTML = `
      <input type="text" name="sections[${sectionId}][groups][${groupIndex}][contenus][]" placeholder="• Texte du bullet point" required>
      <button type="button" onclick="this.parentElement.remove()">❌</button>
    `;
    container.appendChild(div);
  }
</script>
{% endblock %}
